# Plow - Snowflake Target

## Setup

To create the role, permissions, and objects necessary for the tool to operate:

+ utilizing an account that has ACCOUNTADMIN role, establish the required roles and permissions the tool will require, 
execute the script below  

+ Once created the identity to which the tool will operate should utilize the CHANGE_MGMT role as its base role.  
  **It is advised that the tool itself never utilize the ACCOUNTADMIN or SYSADMIN default Snowflake roles as the 
  base role.**


```
USE ROLE ACCOUNTADMIN;

CREATE ROLE IF NOT EXISTS CHANGE_MGMT;
GRANT CREATE DATABASE ON ACCOUNT TO ROLE CHANGE_MGMT;
GRANT CREATE ROLE ON ACCOUNT TO ROLE CHANGE_MGMT;

GRANT ROLE CHANGE_MGMT TO ROLE SYSADMIN;

CREATE DATABASE IF NOT EXISTS CHANGE_CONTROL;
CREATE SCHEMA IF NOT EXISTS CHANGE_CONTROL.PLOW;
CREATE SCHEMA IF NOT EXISTS CHANGE_CONTROL.ORIGIN;
CREATE SCHEMA IF NOT EXISTS CHANGE_CONTROL.VALIDATE;

USE DATABASE CHANGE_CONTROL;
USE SCHEMA PLOW;
CREATE SECURE VIEW CHANGE_CONTROL.PLOW.MANAGED_DATABASES AS SELECT DATABASE_NAME FROM SNOWFLAKE.INFORMATION_SCHEMA.DATABASES;
GRANT SELECT ON VIEW CHANGE_CONTROL.PLOW.MANAGED_DATABASES TO ROLE CHANGE_MGMT;


GRANT OWNERSHIP ON SCHEMA CHANGE_CONTROL.PLOW TO ROLE CHANGE_MGMT;
GRANT OWNERSHIP ON SCHEMA CHANGE_CONTROL.ORIGIN TO ROLE CHANGE_MGMT;
GRANT OWNERSHIP ON SCHEMA CHANGE_CONTROL.VALIDATE TO ROLE CHANGE_MGMT;
GRANT OWNERSHIP ON DATABASE CHANGE_CONTROL TO ROLE CHANGE_MGMT;
USE ROLE CHANGE_MGMT;

-- TABLE: COMMITS
-- PURPOSE:  Commit log tracking of changes applied to database structures form the repository
CREATE TABLE COMMITS (
    COMMIT_ID       VARCHAR(100) NOT NULL, 
    MSG             VARCHAR  NOT NULL,
    EXEC_START      TIMESTAMP_NTZ  NOT NULL,    
    EXEC_END        TIMESTAMP_NTZ  NOT NULL,
    EXEC_WHO        VARCHAR(500)  NOT NULL,
    CHANGE_COUNT    INT  NOT NULL DEFAULT 0,
    CHANGE_SUCCESS  INT  NOT NULL DEFAULT 0,
    CHANGE_FAIL     INT  NOT NULL DEFAULT 0,
    COMPLETED       BOOLEAN  NOT NULL DEFAULT FALSE,
    FAST_FORWARD    BOOLEAN  NOT NULL DEFAULT FALSE
);


-- TABLE: CHANGE LOG
-- PURPOSE:  Change log for each file contained within a commit
CREATE TABLE CHANGE_LOG (
    COMMIT_ID   VARCHAR(100) NOT NULL,
    FILE_NAME   VARCHAR  NOT NULL,
    REF         VARCHAR(65)  NOT NULL,
    HASH        VARCHAR(65)  NOT NULL,
    STATUS      BOOLEAN  NOT NULL,
    EXEC_TIME   TIMESTAMP_NTZ  NOT NULL,
    MSG         VARCHAR  NOT NULL,
    PARTIAL     BOOLEAN  NOT NULL DEFAULT FALSE    
);



```

